user:
先来看看形态，从 08-15 之后，kline 走出了持续下跌的三重底形态，但多头每次回调的力度都很小，每次多头突破的高点和力度都比上一次小，最终在 06-16 到 06-23 走出了历史新低，甚至触及了 2024-09-11 的低点。假设从整体图像观察，2024-09-11开始走出急速上涨行情，是连续的涨停板。随即下撤，走出双重顶后便开始了漫长的下跌行情。并在 2025-01-20 和 2025-04-07 出现双重底形态，后续就是我们当前交易的行情时段，从整体来看，甚至可以说我们在震荡行情中进行交易，最终小亏收场。我们来分析 llm 的交易决策，首先是在 06-11 买入3手，随后在后续两天清仓，我的理解是尝试，不赚不亏，但因为交易手续费产生了几十块钱的亏损。伺候是漫长的 hold，直到 07-08 大幅买入了 75 手，我们需要观察这一点，为什么 llm 如此激进？llm 的确抓住了这波三重顶持续上涨的行情，虽然斜率没有那么大，但还是为我们拿到了 1000 块左右的收益。我觉得这很厉害，属于买低卖高。但随后，07-22 买入 74 手，并在 07-31 至 08-04 侄止损平仓，07-22 的确是一个好的买入信号，但是从形态上看，和 07-10 构成了双重顶。行情在 07-22 之后连续几天无法突破高点，意味着多头动能不足，即将下跌，后续行情也印证了这一点。随后是在震荡行情中持续 hold，直到行情结束。请你评价。

llm:
简短确认 你要我用事实和代码回溯 000002 在 20250515–20250814 的全部交易决策，解释三次关键买入与一次失效止损的成因，并给出策略层面的改进建议。

核心判断

- 策略遵守了既定入场/出场规则，仓位与时机均由预计算旗标驱动，未使用“猜测”或外部信息。
- 06-12买入是严格的均值回归试探，仓位受下跌阶段上限约束，费用导致小亏属正常摩擦成本。
- 07-08大仓位买入是“趋势买入严格”在入场B确认下的中等仓位执行，逻辑完全成立，随后快进快出实现了稳健盈利。
- 07-22再度大仓位买入满足趋势条件，但与07-10形成双顶，动能续航不足；07-31至08-04的分批止损严格遵循“趋势失效”联动规则。
- 08月震荡期持续观望并未错失明显趋势，属于风险约束下的理性空仓或轻仓。
事实依据

- 06-12 均值回归试探
  
  - 触发依据：价格≤布林下轨×1.01与RSI(6)≤30的组合满足，且处于下跌阶段上限。
  - 信号与理由见 specs/backtest/000002/llm_000002.json:501-519 与买入数量决策 specs/backtest/000002/llm_000002.json:503-517 ，实际成交记录 specs/backtest/000002/trades_000002.csv:21-23 。
  - 结论：最小必要仓位的试探买，费用摩擦导致小亏，策略合规。
- 07-08 趋势买入严格与中等仓位
  
  - 触发依据： MACD柱>0且上升 + 连续2日收盘>EMA20 + RSI(12)≥55 全满足。
  - 旗标为真与仓位映射见 specs/backtest/000002/llm_000002.json:969-988 ，决策数量 75 手见 specs/backtest/000002/llm_000002.json:970-985 ，成交记录见 specs/backtest/000002/trades_000002.csv:39-42 。
  - 结论：入场B确认下的≈50%可买手数，快节奏分批退出，盈利约千元，执行优良。
- 07-22 二次趋势买入与后续失效
  
  - 入场依据：再次满足趋势严格条件（RSI(12)≈60，收盘两日>EMA20，MACD柱>0且上升一棒），见 specs/backtest/000002/llm_000002.json:1229-1248 ，成交见 specs/backtest/000002/trades_000002.csv:49 。
  - 形态风险：与 07-10 形成双顶，后续拉升乏力。
  - 失效卖出：07-31 触发 MACD_hist_down + close<EMA20 ，策略旗标 is_trend_invalidation_sell=true ，见 specs/backtest/000002/llm_000002.json:1411-1430 ，分批减仓记录见 specs/backtest/000002/trades_000002.csv:56-58 。
  - 结论：入场合规但形态风险未过滤；失效联动止损执行到位。
- 08-05 至 08-14 震荡持平
  
  - 未触发买卖强信号，处于 downtrend_cap 风险约束，见 specs/backtest/000002/trades_000002.csv:59-66 与多处“hold”逻辑 specs/backtest/000002/llm_000002.json:1400-1405 。
  - 结论：遵守风险上限与冷却节奏，不追震荡。
策略优点

- 规则清晰、可验证：所有关键动作由旗标驱动且具备一致的理由文本。
- 仓位分层合理：入场A给基础仓位、入场B给中等仓位；下跌阶段上限有效控制回撤。
- 失效联动严谨：MACD柱转下与收盘<EMA20的联合条件触发分批减仓，避免拖延。
策略缺陷与潜在风险

- 双顶/前高邻近的形态过滤缺失
  - 07-22在前高密集区（07-10）附近加仓，趋势条件成立但形态不友好，风险-回报偏差。
- “MACD柱≥2棒连续上升”在07-22未完全满足仍允许大仓位
  - 决策文本承认仅一棒上升，仍量化为严格买入，存在“动能确认不足即提仓”的风险，见 specs/backtest/000002/llm_000002.json:1229-1239 。
- 过度依赖单一动量组合
  - RSI、MACD与EMA的三元组合在震荡中易产生假突破，需要体量或波动的佐证。
- 记录解释中对“新低”判断的模糊
  - 多处“避免解析序列”导致对“MACD柱创新低”的禁用条件解释摇摆，易引入边界不一致。
行动计划

- 引入“前高邻近”抑制器（不破坏用户空间，默认关闭）
  - 规则： 若当前价距离最近20日内最高收盘<1.0% 且 RSI(12)<60 → 降级为入场A，仅基础仓位
  - 实施位置：生成 is_trend_buy_strict 后的仓位映射阶段，作为附加降级。
- 强化“MACD柱连续上升”硬约束
  - 将“≥2棒连升”作为中等仓位必要条件；仅一棒上升时维持基础仓位。
  - 影响点：07-22这类情形将降权，减少双顶风险。
- 加入体量或波动确认
  - 选项A： ATR(14) 突破阈值（如当日真实波幅≥近14日均值的1.1×）才允许提仓。
  - 选项B：若量能数据可用，加入“当日成交量≥近20日均量的1.2×”作为趋势买入的加仓门槛。
- 改善日志的“原因码”与一致性
  - 每次买卖输出固定原因码集合： TREND_STRICT_OK , MEAN_REV_OK , TREND_INVALIDATION , OVERBOUGHT_SELL , NEAR_PREV_HIGH_SUPPRESS , MOMENTUM_INSUFFICIENT
  - 统一“MACD柱创新低”禁用的判定窗口（例如最近N=20天），消除“避免解析序列”引发的不一致。
- 节奏保护
  - 在“前高邻近抑制器”或“动能不足”触发时，设置3日冷却，仅在EMA20附近回撤后再评估提仓。
结论

- 回测区间的策略表现是合规、可解释与可复现的：06-12保守试探小亏、07-08严格趋势买入捕获合理收益、07-22趋势满足但形态风险导致止损、08月震荡观望避免过度交易。
- 风险主要集中在“前高邻近”和“动能确认不足时的仓位过度”。建议以不破坏用户空间的可选开关形式增量修正，默认关闭，逐步灰度启用。
- 我关心的是把特殊情况“消掉”：加一层形态/动能降级，把尖锐的双顶、弱动能边界变成正常的“基础仓位”情形。这样你既不牺牲趋势跟随，又减少不必要的止损。