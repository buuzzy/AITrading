# 301396.SZ 回测复盘（2025-09-01 ~ 2025-10-31）

数据来源
- K 线与标注: `/backtest/301396/kline_20250901_20251031.html`
- 成交记录: `/backtest/301396/trades_301396_20250901_20251031.csv`
- LLM 推理日志: `/backtest/301396/llm_returns_301396_20250901_20251031.txt`

结论摘要
- 9 月上半段的“趋势买入”合理；9/24–9/25 高位（近上轨 + RSI≥70）未止盈是本次回测的关键问题。
- 进入下跌后，10/13 与 10/16 的减仓/平仓符合“MACD 下行且价<EMA20”的止损逻辑，风险控制正确。
- 10/20 的“弱均值回归”试探与 10/29 的“边缘趋势买入”在下跌节奏中风险偏大；后续回落导致盈利回吐。
- T+1 约束总体遵守；存在“股/手单位”混用的实现瑕疵，影响可卖手数与风控一致性。

逐日证据与判断
- 2025-09-11（买入 300股，趋势分支）
  - 交易: `trades.csv#10`
  - 触发：MACD 负区向上（-1.73→-1.24），价>EMA20（74.64>66.37），RSI(12)=58.85≥50
  - 日志：判断 trend BUY 满足，信心中等，基线 3 手
- 2025-09-12（买入 200股，趋势延续）
  - 交易: `trades.csv#11`
  - 触发：MACD 继续改善（-1.24→-0.89），价>EMA20，RSI(12)≥50
- 2025-09-16（买入 200股，趋势转正）
  - 交易: `trades.csv#13`
  - 触发：MACD 转正（-0.12→0.06），价>EMA20，RSI(12)≈60.86
- 2025-09-24～2025-09-25（高位未止盈）
  - 交易: `trades.csv#19,#20`（当日 HOLD）
  - 状态：82.93→84.79 接近/几乎触及布林上轨；RSI(6)≈70.37→73.45
  - 冲突：趋势 BUY 有效（MACD>0，价>EMA20）同时满足 SELL 条件（near 上轨 + RSI≥70）
  - 日志：选择 HOLD，错过高位兑现
- 2025-09-26（回落，仍 HOLD）
  - 交易: `trades.csv#21`（HOLD）
  - 状态：MACD 下行但价仍>EMA20；第二 SELL 分支未严格满足
- 2025-10-13（卖出 400股，风险控制正确）
  - 交易: `trades.csv#26`
  - 触发：MACD 显著转下（-0.90→-1.69），价<EMA20（73.02<75.51）
  - 日志：执行 SELL 400（7手→3手），符合“MACD 下行且价<EMA20”
- 2025-10-16（平仓 300股，全平）
  - 交易: `trades.csv#29`
  - 触发：MACD 继续走弱（-3.13），价<EMA20，RSI(6)≈32.64（超卖但趋势走坏）
  - 日志：CLOSE 3 手，止损合理
- 2025-10-20（买入 100股，弱均值回归）
  - 交易: `trades.csv#31`
  - 触发：价接近下轨（67.94 vs 66.24）且 RSI(6)≈30.6≤35；但价<EMA20、MACD 仍深负
  - 日志：小仓试探 1 手，符合 T+1 限制
- 2025-10-29（买入 300股，边缘趋势买入）
  - 交易: `trades.csv#38`
  - 触发：MACD 向上（-1.23→-0.63），价略>EMA20（71.73>71.37），RSI(12)≈50.77≥50
  - 日志：trend BUY 满足、信心中等，基线 3 手；后续 10/30–10/31 因无 SELL 触发选择 HOLD

问题归纳
- 高位兑现缺失
  - 9/24–9/25 明确满足“near 上轨 + RSI(6)≥70”的 SELL 条件（日志与指标一致），仍选择 HOLD，导致利润未锁定
- 下跌中补仓过于积极
  - 10/20 在“价<EMA20 + MACD 新低”背景下一手试探；10/29 虽满足趋势 BUY，但信号边缘（价仅略高 EMA20、MACD 仍负），回调风险高
- 失效条件与节奏不稳定
  - HOLD 阶段反复提示“连续两日低于 EMA20”的失效条件，但未形成明确减仓节奏与冷却期
- 数量单位 Bug（股/手混用）
  - 10/30–10/31 推理出现“当前有400手 / 最多可卖4手”的表述；真实应为 400股（4手）
  - 影响：`max_sellable_lots` 与持仓手数不一致，可能导致风控在边界场景出错
  - 证据：`llm_returns.txt` 末段对 10/29 后持仓与可卖手数的描述片段（5700–5842）

T+1 行为核验
- 当天新买不可卖、次日可卖既有持仓：日志与成交记录一致（例如 9/11 当天仅允许 ['buy','hold']；10/13/10/16 的卖出发生在次日或更晚）

建议的轻量修正（最小改动）
- 趋势买入更严格
  - 必须：MACD 柱状图≥0 且连续两日上升；收盘价连续两日 > EMA20；RSI(12)≥52
  - 禁止：RSI(6)>65 或价格距上轨 <2% 时加仓
- 均值回归仅在强极值
  - 必须：收盘价 ≤ 下轨×1.01 且 RSI(6)≤30；若价<EMA20 且 MACD 创新低，禁止补仓
  - 试探仓位≤1手，除非次日出现趋势确认
- 高位止盈明确化
  - 触发：near/above 上轨 且 RSI(6)≥68；执行减仓 30–50%，若当日量能放大或长上影线，优先平掉弱手
- 下跌通道仓位上限
  - 定义：价<EMA20 且 MACD 负区创新低；总仓位 ≤20% 净值；通道内只允许“减仓或 HOLD”
- 冷却与节奏
  - 止损/减仓后 3–5 个交易日仅允许 HOLD 或≤1手试探；单日最多 1 次交易
- 统一单位与风控
  - 底层以“股”为度量，统一转换为“手”；`max_sellable_lots = floor(shares / 100)` 使用同一来源函数，买卖一致

可直接集成的 Prompt 片段
- 趋势分支：
  - “仅当 MACD_hist ≥ 0 且最近两日连续上升、close 两日均 > EMA20、RSI(12) ≥ 52 时允许 trend BUY；若 RSI(6) > 65 或 close 距上轨 < 2%，禁止加仓。”
- 均值回归分支：
  - “仅当 close ≤ lower_band × 1.01 且 RSI(6) ≤ 30 时允许 mean-reversion BUY；若 close < EMA20 且 MACD_hist 创新低，禁止补仓；试探规模 ≤ 1 手。”
- 止盈与下跌通道：
  - “当 close near/above 上轨 且 RSI(6) ≥ 68，执行减仓 30–50%；当处于下跌通道（close < EMA20 且 MACD_hist 创新低），总仓位 ≤ 20%，仅减仓或 HOLD。”
- 节奏：
  - “止损或减仓后的 3–5 个交易日进入冷却，仅允许 HOLD 或至多 1 手试探；当日最多 1 次交易。”

后续动作建议
- 将上述 Prompt 片段并入当前决策模块，修复“股/手”单位的统一转换。
- 重新回测 301396（同区间），重点观察：
  - 9/24–9/25 是否能在高位稳定减仓
  - 10/20、10/29 是否减少或避免补仓
- 输出对比（胜率、最大回撤、交易次数、平均盈亏），评估修正收益。

## 策略/提示词/因子问题清单

- 止盈不果断：9/24–9/25 满足 near 上轨 + RSI(6)≥70，仍 HOLD，未锁定高位利润。
- 趋势买入确认不严：MACD 仍负区但向上、价仅略高 EMA20 即加仓，易在弱反弹中追高。
- 均值回归过松：在 close<EMA20 且 MACD 创新低的下跌通道里仍允许试探补仓，提升回撤风险。
- 市场情境缺少限制：无“下跌通道仓位上限”与“冷却期”，交易节奏不稳定。
- 单位一致性：日志中出现“400手”等表述，真实应为“400股（4手）”，影响最大可卖手数的解释。
- 失效条件未联动动作：频繁提示“连续两日低于 EMA20”，但未形成“减仓 + 冷却”的可执行节奏。

## 因子与阈值的适配问题

- 趋势分支：建议仅在 MACD_hist≥0 且连续两日上升、close 两日均>EMA20、RSI(12)≥52 时允许买入；若 RSI(6)>65 或距上轨<2%，禁止加仓。
- 均值回归分支：建议仅在 close ≤ lower_band×1.01 且 RSI(6)≤30 时触发；若 close<EMA20 且 MACD_hist 创新低，禁止补仓；试探≤1手，除非次日出现趋势确认。
- 止盈与下跌通道：near/above 上轨 且 RSI(6)≥68 触发减仓 30–50%；处于“close<EMA20 + MACD_hist 创新低”的通道时，总仓位 ≤20%，仅减仓/HOLD。
- 节奏：止损/减仓后 3–5 个交易日冷却，仅允许 HOLD 或≤1手试探；单日最多 1 次交易。

## T+1 与单位一致性

- T+1 约束：当天新买不可卖、次日可卖既有持仓（本回测整体遵守）。
- 单位统一：底层以“股”为度量，统一换算为“手”；用同一函数计算 `max_sellable_lots = floor(shares / 100)`，避免“股/手”混用导致风控解释错误。

## 总结

- 在上行中，趋势加仓的逻辑是合理的；问题主要出现在高位止盈不果断与下跌通道中的过早/过多试探。
- 建议通过更严格的趋势确认、更严苛的均值回归触发、明确的止盈机制、下跌通道仓位上限与冷却节奏来降低在下跌市中的误操作与回撤。
- 单位一致性应纳入提示词/实现的强约束，确保可卖手数与持仓一致，避免边界场景风控错配。